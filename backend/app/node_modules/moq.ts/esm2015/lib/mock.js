import { ExpectedExpressionReflector } from "./expected-expressions/expected-expression-reflector";
import { ProxyFactory } from "./interceptors/proxy.factory";
import { Times } from "./times";
import { Tracker } from "./tracker/tracker";
import { Verifier } from "./verification/verifier";
import { PrototypeStorage } from "./interceptors/prototype.storage";
import { injectorFactory } from "./injector/injector.factory";
import { MOCK } from "./injector/moq.injection-token";
import { MOCK_OPTIONS } from "./mock-options/mock-options.injection-token";
import { PRESET_BUILDER_FACTORY } from "./presets/preset-builder-factory.injection-token";
import { DefaultInjectorConfig } from "./injector/default-injector.config";
/**
 * The default implementation of {@link IMock} interface.
 */
export class Mock {
    constructor(options = {}) {
        this.options = options;
        const preOptions = Object.assign(Object.assign({}, Mock.options), options);
        const provider = { provide: MOCK, useValue: this, deps: [] };
        const injector = injectorFactory(preOptions, provider);
        this.options = injector.get(MOCK_OPTIONS);
        this.tracker = injector.get(Tracker);
        this.expressionReflector = injector.get(ExpectedExpressionReflector);
        this.interceptor = injector.get(ProxyFactory);
        this.setupFactory = injector.get(PRESET_BUILDER_FACTORY);
        this.verifier = injector.get(Verifier);
        this.prototypeStorage = injector.get(PrototypeStorage);
    }
    /**
     * The default mock options that would applied to all instantiating Mock objects.
     * By default it sets {@link IMockOptions.target} as a function, {@link IMockOptions.injectorConfig} as
     * instance of {@link DefaultInjectorConfig} and {@link IMockOptions.name} as undefined.
     * If an options are passed as constructor parameter {@link Mock.constructor} they will override the default options.
     */
    static get options() {
        if (Mock.Options === undefined) {
            Mock.Options = {
                target: () => undefined,
                injectorConfig: new DefaultInjectorConfig()
            };
        }
        return Mock.Options;
    }
    /**
     * The default mock options that would applied to all instantiating Mock objects.
     * If an options are passed as constructor parameter they will override the default options.
     */
    static set options(options) {
        Mock.Options = options;
    }
    get name() {
        return this.options.name;
    }
    setup(expression) {
        const expectedExpression = this.expressionReflector.reflect(expression);
        return this.setupFactory(expectedExpression);
    }
    verify(expression, times) {
        times = times === undefined ? Times.Once() : times;
        const expressions = this.tracker.get().map(record => record.expression);
        this.verifier.test(expression, times, expressions, this.name);
        return this;
    }
    object() {
        return this.interceptor.object();
    }
    prototypeof(prototype) {
        this.prototypeStorage.set(prototype);
        return this;
    }
    /**
     * @experimental
     */
    insequence(sequence, expression) {
        sequence.add(this, expression);
        return this;
    }
}
Mock.Options = undefined;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9tb3Evc3JjLyIsInNvdXJjZXMiOlsibGliL21vY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLDJCQUEyQixFQUF1QixNQUFNLHNEQUFzRCxDQUFDO0FBQ3hILE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU1RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFbkQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzlELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFDM0UsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFDMUYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFM0U7O0dBRUc7QUFDSCxNQUFNLE9BQU8sSUFBSTtJQVNiLFlBQTRCLFVBQTJCLEVBQUU7UUFBN0IsWUFBTyxHQUFQLE9BQU8sQ0FBc0I7UUFFckQsTUFBTSxVQUFVLEdBQUcsZ0NBQUksSUFBSSxDQUFDLE9BQU8sR0FBSyxPQUFPLENBQW9CLENBQUM7UUFDcEUsTUFBTSxRQUFRLEdBQUcsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBQyxDQUFDO1FBRTNELE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxXQUFXLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM5QyxJQUFJLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxNQUFNLEtBQUssT0FBTztRQUNkLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxTQUFTLEVBQUU7WUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRztnQkFDWCxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsU0FBUztnQkFDdkIsY0FBYyxFQUFFLElBQUkscUJBQXFCLEVBQUU7YUFDOUMsQ0FBQztTQUNMO1FBQ0QsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLEtBQUssT0FBTyxDQUFDLE9BQThCO1FBQzdDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFXLElBQUk7UUFDWCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0lBQzdCLENBQUM7SUFFTSxLQUFLLENBRTZDLFVBQWE7UUFDbEUsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3hFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTSxNQUFNLENBQUMsVUFBa0MsRUFBRSxLQUFhO1FBQzNELEtBQUssR0FBRyxLQUFLLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNuRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4RSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLE1BQU07UUFDVCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDckMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxTQUFlO1FBQzlCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDckMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksVUFBVSxDQUFDLFFBQTJCLEVBQUUsVUFBa0M7UUFDN0UsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDL0IsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQzs7QUFqRmMsWUFBTyxHQUEwQixTQUFTLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeHBlY3RlZEV4cHJlc3Npb25SZWZsZWN0b3IsIElFeHBlY3RlZEV4cHJlc3Npb24gfSBmcm9tIFwiLi9leHBlY3RlZC1leHByZXNzaW9ucy9leHBlY3RlZC1leHByZXNzaW9uLXJlZmxlY3RvclwiO1xuaW1wb3J0IHsgUHJveHlGYWN0b3J5IH0gZnJvbSBcIi4vaW50ZXJjZXB0b3JzL3Byb3h5LmZhY3RvcnlcIjtcbmltcG9ydCB7IElNb2NrLCBJTW9ja09wdGlvbnMsIElQcmVzZXRCdWlsZGVyLCBJU2VxdWVuY2VWZXJpZmllciB9IGZyb20gXCIuL21vcVwiO1xuaW1wb3J0IHsgVGltZXMgfSBmcm9tIFwiLi90aW1lc1wiO1xuaW1wb3J0IHsgVHJhY2tlciB9IGZyb20gXCIuL3RyYWNrZXIvdHJhY2tlclwiO1xuaW1wb3J0IHsgVmVyaWZpZXIgfSBmcm9tIFwiLi92ZXJpZmljYXRpb24vdmVyaWZpZXJcIjtcbmltcG9ydCB7IEV4cGVjdGVkRXhwcmVzc2lvbnMgfSBmcm9tIFwiLi9leHBlY3RlZC1leHByZXNzaW9ucy9leHBlY3RlZC1leHByZXNzaW9uc1wiO1xuaW1wb3J0IHsgUHJvdG90eXBlU3RvcmFnZSB9IGZyb20gXCIuL2ludGVyY2VwdG9ycy9wcm90b3R5cGUuc3RvcmFnZVwiO1xuaW1wb3J0IHsgaW5qZWN0b3JGYWN0b3J5IH0gZnJvbSBcIi4vaW5qZWN0b3IvaW5qZWN0b3IuZmFjdG9yeVwiO1xuaW1wb3J0IHsgTU9DSyB9IGZyb20gXCIuL2luamVjdG9yL21vcS5pbmplY3Rpb24tdG9rZW5cIjtcbmltcG9ydCB7IE1PQ0tfT1BUSU9OUyB9IGZyb20gXCIuL21vY2stb3B0aW9ucy9tb2NrLW9wdGlvbnMuaW5qZWN0aW9uLXRva2VuXCI7XG5pbXBvcnQgeyBQUkVTRVRfQlVJTERFUl9GQUNUT1JZIH0gZnJvbSBcIi4vcHJlc2V0cy9wcmVzZXQtYnVpbGRlci1mYWN0b3J5LmluamVjdGlvbi10b2tlblwiO1xuaW1wb3J0IHsgRGVmYXVsdEluamVjdG9yQ29uZmlnIH0gZnJvbSBcIi4vaW5qZWN0b3IvZGVmYXVsdC1pbmplY3Rvci5jb25maWdcIjtcblxuLyoqXG4gKiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiB7QGxpbmsgSU1vY2t9IGludGVyZmFjZS5cbiAqL1xuZXhwb3J0IGNsYXNzIE1vY2s8VD4gaW1wbGVtZW50cyBJTW9jazxUPiB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgT3B0aW9uczogSU1vY2tPcHRpb25zPHVua25vd24+ID0gdW5kZWZpbmVkO1xuICAgIHB1YmxpYyByZWFkb25seSB0cmFja2VyOiBUcmFja2VyO1xuICAgIHByaXZhdGUgZXhwcmVzc2lvblJlZmxlY3RvcjogRXhwZWN0ZWRFeHByZXNzaW9uUmVmbGVjdG9yO1xuICAgIHByaXZhdGUgaW50ZXJjZXB0b3I6IFByb3h5RmFjdG9yeTxUPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNldHVwRmFjdG9yeTogKHRhcmdldDogRXhwZWN0ZWRFeHByZXNzaW9uczxUPikgPT4gSVByZXNldEJ1aWxkZXI8VD47XG4gICAgcHJpdmF0ZSB2ZXJpZmllcjogVmVyaWZpZXI8VD47XG4gICAgcHJpdmF0ZSBwcm90b3R5cGVTdG9yYWdlOiBQcm90b3R5cGVTdG9yYWdlO1xuXG4gICAgY29uc3RydWN0b3IocHVibGljIHJlYWRvbmx5IG9wdGlvbnM6IElNb2NrT3B0aW9uczxUPiA9IHt9KSB7XG5cbiAgICAgICAgY29uc3QgcHJlT3B0aW9ucyA9IHsuLi5Nb2NrLm9wdGlvbnMsIC4uLm9wdGlvbnN9IGFzIElNb2NrT3B0aW9uczxUPjtcbiAgICAgICAgY29uc3QgcHJvdmlkZXIgPSB7cHJvdmlkZTogTU9DSywgdXNlVmFsdWU6IHRoaXMsIGRlcHM6IFtdfTtcblxuICAgICAgICBjb25zdCBpbmplY3RvciA9IGluamVjdG9yRmFjdG9yeShwcmVPcHRpb25zLCBwcm92aWRlcik7XG5cbiAgICAgICAgdGhpcy5vcHRpb25zID0gaW5qZWN0b3IuZ2V0KE1PQ0tfT1BUSU9OUyk7XG4gICAgICAgIHRoaXMudHJhY2tlciA9IGluamVjdG9yLmdldChUcmFja2VyKTtcbiAgICAgICAgdGhpcy5leHByZXNzaW9uUmVmbGVjdG9yID0gaW5qZWN0b3IuZ2V0KEV4cGVjdGVkRXhwcmVzc2lvblJlZmxlY3Rvcik7XG4gICAgICAgIHRoaXMuaW50ZXJjZXB0b3IgPSBpbmplY3Rvci5nZXQoUHJveHlGYWN0b3J5KTtcbiAgICAgICAgdGhpcy5zZXR1cEZhY3RvcnkgPSBpbmplY3Rvci5nZXQoUFJFU0VUX0JVSUxERVJfRkFDVE9SWSk7XG4gICAgICAgIHRoaXMudmVyaWZpZXIgPSBpbmplY3Rvci5nZXQoVmVyaWZpZXIpO1xuICAgICAgICB0aGlzLnByb3RvdHlwZVN0b3JhZ2UgPSBpbmplY3Rvci5nZXQoUHJvdG90eXBlU3RvcmFnZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhlIGRlZmF1bHQgbW9jayBvcHRpb25zIHRoYXQgd291bGQgYXBwbGllZCB0byBhbGwgaW5zdGFudGlhdGluZyBNb2NrIG9iamVjdHMuXG4gICAgICogQnkgZGVmYXVsdCBpdCBzZXRzIHtAbGluayBJTW9ja09wdGlvbnMudGFyZ2V0fSBhcyBhIGZ1bmN0aW9uLCB7QGxpbmsgSU1vY2tPcHRpb25zLmluamVjdG9yQ29uZmlnfSBhc1xuICAgICAqIGluc3RhbmNlIG9mIHtAbGluayBEZWZhdWx0SW5qZWN0b3JDb25maWd9IGFuZCB7QGxpbmsgSU1vY2tPcHRpb25zLm5hbWV9IGFzIHVuZGVmaW5lZC5cbiAgICAgKiBJZiBhbiBvcHRpb25zIGFyZSBwYXNzZWQgYXMgY29uc3RydWN0b3IgcGFyYW1ldGVyIHtAbGluayBNb2NrLmNvbnN0cnVjdG9yfSB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgb3B0aW9ucy5cbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0IG9wdGlvbnMoKSB7XG4gICAgICAgIGlmIChNb2NrLk9wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgTW9jay5PcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHRhcmdldDogKCkgPT4gdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIGluamVjdG9yQ29uZmlnOiBuZXcgRGVmYXVsdEluamVjdG9yQ29uZmlnKClcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIE1vY2suT3B0aW9ucztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgZGVmYXVsdCBtb2NrIG9wdGlvbnMgdGhhdCB3b3VsZCBhcHBsaWVkIHRvIGFsbCBpbnN0YW50aWF0aW5nIE1vY2sgb2JqZWN0cy5cbiAgICAgKiBJZiBhbiBvcHRpb25zIGFyZSBwYXNzZWQgYXMgY29uc3RydWN0b3IgcGFyYW1ldGVyIHRoZXkgd2lsbCBvdmVycmlkZSB0aGUgZGVmYXVsdCBvcHRpb25zLlxuICAgICAqL1xuICAgIHN0YXRpYyBzZXQgb3B0aW9ucyhvcHRpb25zOiBJTW9ja09wdGlvbnM8dW5rbm93bj4pIHtcbiAgICAgICAgTW9jay5PcHRpb25zID0gb3B0aW9ucztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG5hbWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMubmFtZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0dXA8XG4gICAgICAgIEUgZXh0ZW5kcyBJRXhwZWN0ZWRFeHByZXNzaW9uPFQ+LFxuICAgICAgICBSID0gRSBleHRlbmRzICguLi5hcmdzOiBhbnlbXSkgPT4gaW5mZXIgTSA/IE0gOiBhbnk+KGV4cHJlc3Npb246IEUpOiBJUHJlc2V0QnVpbGRlcjxULCBSPiB7XG4gICAgICAgIGNvbnN0IGV4cGVjdGVkRXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvblJlZmxlY3Rvci5yZWZsZWN0KGV4cHJlc3Npb24pO1xuICAgICAgICByZXR1cm4gdGhpcy5zZXR1cEZhY3RvcnkoZXhwZWN0ZWRFeHByZXNzaW9uKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdmVyaWZ5KGV4cHJlc3Npb246IElFeHBlY3RlZEV4cHJlc3Npb248VD4sIHRpbWVzPzogVGltZXMpOiBJTW9jazxUPiB7XG4gICAgICAgIHRpbWVzID0gdGltZXMgPT09IHVuZGVmaW5lZCA/IFRpbWVzLk9uY2UoKSA6IHRpbWVzO1xuICAgICAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMudHJhY2tlci5nZXQoKS5tYXAocmVjb3JkID0+IHJlY29yZC5leHByZXNzaW9uKTtcbiAgICAgICAgdGhpcy52ZXJpZmllci50ZXN0KGV4cHJlc3Npb24sIHRpbWVzLCBleHByZXNzaW9ucywgdGhpcy5uYW1lKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIG9iamVjdCgpOiBUIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJjZXB0b3Iub2JqZWN0KCk7XG4gICAgfVxuXG4gICAgcHVibGljIHByb3RvdHlwZW9mKHByb3RvdHlwZT86IGFueSk6IElNb2NrPFQ+IHtcbiAgICAgICAgdGhpcy5wcm90b3R5cGVTdG9yYWdlLnNldChwcm90b3R5cGUpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAZXhwZXJpbWVudGFsXG4gICAgICovXG4gICAgcHVibGljIGluc2VxdWVuY2Uoc2VxdWVuY2U6IElTZXF1ZW5jZVZlcmlmaWVyLCBleHByZXNzaW9uOiBJRXhwZWN0ZWRFeHByZXNzaW9uPFQ+KTogSU1vY2s8VD4ge1xuICAgICAgICBzZXF1ZW5jZS5hZGQodGhpcywgZXhwcmVzc2lvbik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbn1cbiJdfQ==